version: 2.1

orbs:
  goreleaser: hubci/goreleaser@1.0.0
  go: circleci/go@1.7.0
  terraform: circleci/terraform@2.1.0
  wait-for: cobli/wait-for@0.0.2

executors:
  default:
    docker:
      - image: cimg/go:1.16

jobs:
  build:
    executor: default
    steps:
      - checkout
      - run:
          name: Build provider
          command: make install

  acceptance-tests:
    parameters:
      dokku-version:
        type: string
    environment:
      DOKKU_SSH_HOST: "127.0.0.1"
      DOKKU_SSH_PORT: 3022
      DOKKU_SSH_CERT: "/tmp/dokku-ssh"
    machine:
      image: ubuntu-2004:202010-01
    steps:
      - checkout
      - go/install:
          version: "1.16"
      - terraform/install:
          terraform_version: "1.0.5"
      - run:
          name: Pull dokku image
          command: |
            sudo docker pull dokku/dokku:<< parameters.dokku-version >>
      - run:
          name: Setup dokku plugins
          command: |
            sudo mkdir -p /var/lib/dokku
            sudo cp .circleci/plugin-list /var/lib/dokku/
      - run:
          name: Start dokku container
          command: |
            sudo docker container run \
              --env DOKKU_HOSTNAME=dokku.me \
              --name dokku \
              --publish 3022:22 \
              --publish 8080:80 \
              --publish 8443:443 \
              --volume /var/lib/dokku:/mnt/dokku \
              --volume /var/run/docker.sock:/var/run/docker.sock \
              -d \
              dokku/dokku:<< parameters.dokku-version >>
      - run:
          name: Setup SSH key with container
          command: |
            ssh-keygen -t rsa -N "" -f dokku-ssh
            sudo docker cp dokku-ssh.pub dokku:/tmp/dokku-ssh.pub
            sudo cp dokku-ssh /tmp/dokku-ssh # easy absolute path to ref later
            sudo docker exec dokku dokku ssh-keys:add dokku dokku-ssh.pub
      - wait-for/sh-command:
          timeout: 90
          sh-command: ssh -i dokku-ssh dokku@127.0.0.1 -p 3022
      - run:
          name: Run acceptance tests
          command: make testacc

  release:
    parameters:
      dry-run:
        type: boolean
        default: false
    executor: default
    steps:
      - checkout
      - run:
          name: Import signing key
          command: |
            echo $OSS_SIGNING_KEY | base64 --decode | gpg --batch --no-tty --import --yes
            touch /tmp/.circleci-gpg-setup
            echo $OSS_SIGNING_PASS | gpg -a --detach-sign --passphrase-fd 0 --pinentry-mode loopback /tmp/.circleci-gpg-setup
      - goreleaser/install:
          version: "0.173.2"
      - goreleaser/release:
          dry-run: << parameters.dry-run >>

workflows:
  build:
    jobs:
      - build

      - acceptance-tests:
          matrix:
            parameters:
              dokku-version: ["0.24.10", "0.25.1"]
          requires:
            - build

      - release:
          context:
            - github-release
            - oss-signing-key
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - /.*/
